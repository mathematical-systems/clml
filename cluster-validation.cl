#||
(let ((*read-default-float-format* 'double-float))
  (load "defsystem.cl") (excl:load-system :machine-learning :compile t))

(progn (setf cluster-validation:*workspace* 
         (k-means:k-means 
          10 
          (read-data:pick-and-specialize-data 
           (read-data:read-data-from-file
            "sample/norm-interp-feature.sexp") :except '(0)
            :data-types (make-list 12 :initial-element :numeric))))nil)
||#

(defpackage :cluster-validation
  (:use :cl
        :hjs.learn.k-means
	:hjs.util.vector :hjs.util.meta
	:iterate)
  (:export 
   :*workspace*
   :dunn-index
   :davies-bouldin-index
   :calinski
   :hartigan
   :ball-and-hall
   :global-silhouette-value))

(in-package :cluster-validation)

(defvar *workspace*)

(defdoublefunc v-diff-sum^2 (dvec dvec))

(defun v-diff-sum^2 (x y)
  (declare (type dvec x y))

  (let ((result 0.0d0))
    (declare (type (double-float 0.0) result))
    (do-vecs ((ex x :type double-float)
	      (ey y :type double-float))
      (let ((diff (- ex ey)))
	(incf result (* diff diff))))
    result))
  

(defparameter *distance* :euclid) ; :manhattan :euclid or :cosine
(defun set-distance (method)
  (assert 
      (or (eq method :euclid) (eq method :manhattan) (eq method :cosine)))
  (setf *distance* method))
      

#-(and)
(defun-speedy d (x y)
  (euclid-distance x y))
#-(and)
(defmacro d (x y)
  `(locally 
       (declare (optimize speed (safety 0) (debug 0) (:explain :inlining)))
     (vml::sse3-euclid-indirect (length ,x) ,x ,y)))
; TODO
; add manhattan and cosine distance calculation of sse3

#+(and)
(defmacro d (x y)
  `(ecase *distance*
     (:euclid (euclid-distance ,x ,y))
     (:manhattan (manhattan-distance ,x ,y))
     (:cosine (cosine-distance ,x ,y))))
  
(defun foo (x y)
  (d x y))


(defdoublefunc d-func (dvec dvec))
(defun-speedy d-func (x y)
  (declare (optimize speed (safety 0) (debug 0))
	   (type (simple-array double-float) x y))
  (d x y))




#-(and)
(defun-speedy p-d (x y)
  (let ((xn (p-id x)) (yn (p-id y)))
    (when (> xn yn)
      (let ((tmp xn))
	(setf xn yn
	      yn tmp)))
    (p-internal-d (+ (* yn (length (pw-points *workspace*))) xn))))

(defun-speedy p-d (x y)
  (d (p-pos x) (p-pos y)))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defun symbolicate (&rest args)
    (intern
     (with-standard-io-syntax
     (format nil "窿狎珞┅┅ㄤ彐躅礤盹翎忪瀛簌礅镬钺礤戾è疳汶徵濯簌礅镬疳汶徵钺礤┅簌礅镬殂狒Д钺礤Лロ屙锃翎忪濠┅ㄤ彐磲泸滹礤盹躔溽翦翎忪疳蜥眢珏瞽鲠祯濠鏖翳躅轳蹂钺礤脲啜戾è脲ㄣ镱è铒ㄣ潋疳蜥眢┅ㄦ轵篝疳蜥眢┅è铒ㄣ滗疳蜥眢┅啜泔铙ㄦ轵篝疳蜥眢箦泔钿疳蜥眢┅啜磲脲狎蜥戾铉翳疳蜥眢┅┅┅ㄤ邈灬蝈ㄤ钺黹悱屮翦铘脲┅麒孱ㄣ滗疳蜥眢啜箦翩括祜镳骘轭疳蜥眢骘骝镯泔祆邈啜狎彐脲椹泔祆邈皓┅ㄧ弭栳箬矧箦脲翎忪珏瞽鲠祯濠┅ㄤ彐磲泸溴骓屙ㄤ彐躅钺礤灬礅溽扉篝怙澌怙澌戾è翎忪瀛钺礤礤盹翎忪瀛簌礅镬钺礤┅ㄩ铘弪钺簌礅镬殂狒Д钺礤Д汜煦蹯狒濠ㄡ蜱灬礅溽扉篝┅啜痱镧ㄤ彐鲠翎忪瀛钺礤ì溴骢轭翦蝾犰灬礅溽扉篝棱镤ì溴骢钺礤灬礅溽扉篝ㄤ锃礤盹躔溽翦翎忪瀛钺礤狎珞ì轭翦蝾犰泪蜱螬┅┅ㄤ彐磲泸鏖翳礤盹è蝈篝礤盹螬怙澌怙澌啜戾祜镳骘轭礤盹泔祆邈啜礤盹翎忪瀛簌礅镬愆磲脲栳箬翎忪呼弩у聃犰┅棱镤┅ㄤ彐滹踱戾骢钽薏ㄤ秕忪瀛骒镝舂ㄤ彐躅箴邋澌薏í┅ㄤ彐躅箴邋澌洵翎⑼犷栳趑犷溟篝犷沐翎殂徕礤趄殂瘫溟篝犷沐矧蝈泗殪轭遽溟篝犷沐祜镳骘徙蝻篌骘徙蝻篌篚眄轭ㄡ怏ō猢┅ㄤ彐躅箴邋澌洵艴沆殇⑴蹉扉溴犷溟篝犷沐篝蜥殓梏扉铄溟篝犷沐篑螋祜镳骘徙蝻篌骘徙蝻篌篚眄轭ㄞō猢┅┅ㄤ彐躅箴邋澌洵汨邂箬弼祜镳骘徙蝻篌骘徙蝻篌磲轫辁轭ㄡ怏ō猢┅ㄤ彐礤盹溴骢瞽箴邋澌瓠轭翦蝾犰ㄣ镤邃痫轭趔眭祠轲戾鲠祯瀛忾钿瞟ㄦ祜矧泔溴洵痫轭趔戾铉翳瘅痫轭趔黠螂箴徙濯┅戾èㄥ祠瘅痫轭趔黠螂箴徙濯瞟ㄥ祠瘅痫轭趔黠螂箴徙濯瞟┅ㄤ瓠痫瓠痫┅┅ㄤ彐躅箴邋澌洵卑鞍ī戾è磲脲漩邈卑┅磲脲漩邈卑┅祜镳蝈疱狒卑鞍滹ㄤ┅┅ㄤ彐躅箴邋澌铒īㄤ彐躅箴邋澌铒瓠卑ī祜镳蝈疱狒卑滹铒皓┅－ㄡ钿ㄤ彐躅箴邋澌ㄤ邈灬蝈镳糸黹箴邋筢驽豉癌ㄤ邂蹒癌┅戾è戾铉翳┅戾è繇磲脲狎蜥卑鞍哄戾礤铘豉疱Ж躅箝珙邃怡翦俯┅ㄤ邈灬蝈ㄤ钺黹悱屮翦铘繇皓鲰旌狐ャ骀榄骘蝈殓瞽骢钽糸镱帜诱曼繇皓鲰旌狐ャ骀榄骘蝈殓瞽骢钽糸镱寐塘舆奈彝颤繇暴┅ㄤ彐躅箴邋澌箦泔钿沆矬弩舡沆躞翦皓ㄤ邈灬蝈镳糸黹箴邋洎戾è沆躞翦蝮瘅沆躞翦蝮黠螂箴徙濯┅戾ㄣ祜箦篝铄舡沆矬弩ㄣ盹篝痫箝糸鲥滹踱戾骒镝舂瞽悱盹篝痫箝糸鲥滹踱戾骒镝舂ㄩ翦ㄦ矧轭箦聃孱沐沆躞翦蝮ㄦ矧溟篝犷沐ㄤㄣ沐铘弪悌瓠痫皓┅麒孱悱溟篝犷沐麒孱瞽悱悱洎箦翩铄舡沆矬弩沆矬弩瞽悱悱洎箦翩沆矬弩悱溟篝犷沐┅麒孱ㄡ钿铒ㄥ沆矬弩舂瞽悱溟篝犷沐┅箦翩铄舡沆矬弩瞽悱溟篝犷沐┅ㄡ篌弪ㄥ沆矬弩瓠秣铄皓┅铄舡沆矬弩舂┅ㄤ彐躅瓠赭锃沆矬弩舡沆躞翦蝮皓鲠祯弩瓠秣铄皓箦泔钿沆矬弩舡沆躞翦皓┅ㄤ彐躅箝扈秕弭翦鏖漪皓ㄦ戾è狯弪徵瀛溟篌轫蹯狎轸ㄣ祜镳骘鸨轭ㄣ痫轭趔悌篚眄轭瓠鸨皓轭麸泔躅糸铉轭麸骈钺祆蝈趱蝾ǒ瞟┅┅眭祠轲戾鲠祯瀛忾钿ㄣ祜箦篝铄舡沆矬弩舂瓠赭锃沆矬弩舡沆躞翦蝮皓戾èㄡ鲥蜥珏溟篌轫蹯狎轸沆矬弩舂ㄢㄡ鲥蜥珏溟篌轫蹯狎轸铄舡沆矬弩舂┅ǒō岍磲猢┅┅ㄤ彐躅箝扈秕弭翦ㄣ祯篝弪祜镳骘轭ㄣ痫轭趔沆躞翦颟泔躅糸铉轭麸篚眄轭箝扈秕弭翦鏖漪皓轭麸骈钺祆蝈趱蝾ǒ瞟┅ㄤ彐躅轭趄徙祯篝弪泔眇戾翦溟犴弭弪ㄣ祜镳骘轭ㄣ痫轭趔悌磲轫辁轭祜镳骘轭ㄣ痫轭趔悌躅戾篌ㄥ瘵磲轫辁轭瓠瘵┅ㄤ彐躅轭趄徙祯篝弪狯弪徵瀛溟犴弭弪ㄣ祜镳骘轭ㄣ痫轭趔悌泔躅糸铉轭麸篚眄轭祜镳骘轭ㄣ痫轭趔悌躅戾篌ㄥ瘵篚眄轭瓠瘵轭麸骈钺祆蝈趱蝾ǒíū瞟┅┅ㄤ彐躅悱沐铘蝻殇ㄣㄣ沐铘弪悌ㄤ彐躅轭趄徙祯篝弪沐铘蝻殇溟犴弭弪ㄣ戾舄è痫轭趔ㄣ痫轭趔悌戾铉翳痫轭趔┅ㄣ孱趄镩ㄣ沐铘蝻殇悌┅íǒ祜镳骘轭痫轭趔篚眄轭ㄤ瓠痫皓沐铘蝻殇┅瞟┅ㄤ彐躅轭翦蜚祯篝弪箝铉戾扉铍徵ㄣ惚戾è惆痫轭趔ㄣ痫轭趔惆┅ㄣ杯痫轭趔ㄣ痫轭趔惚┅ㄩ翦ㄦ矧轭箦聃孱沐惆痫轭趔黹铋黹轭祜镳骘轭惚痫轭趔黹铋黹轭瓠┅┅┅ㄤ彐躅轭翦蜚祯篝弪泔眇戾翦扉铍徵ㄣ惚戾è惆痫轭趔ㄣ痫轭趔惆┅ㄣ杯痫轭趔ㄣ痫轭趔惚┅ㄩ翦ㄦ矧轭箦聃孱沐惆痫轭趔磲轫辁轭祜镳骘轭惚痫轭趔磲轫辁轭瓠┅┅┅ㄤ彐躅轭翦蜚祯篝弪狯弪徵瀛扉铍徵ㄣ惚戾è惆痫轭趔ㄣ痫轭趔惆┅ㄣ杯痫轭趔ㄣ痫轭趔惚┅戾è惆戾铉翳惆痫轭趔┅ㄣ杯戾铉翳惚痫轭趔┅ǒ祜镳骘轭惆痫轭趔篚眄轭祜镳骘轭惚痫轭趔篚眄轭瓠┅惆惚瞟┅ㄤ彐躅轭翦蜚祯篝弪沐铘蝻殇扉铍徵ㄣ惚ㄤㄣ沐铘蝻殇惆ㄣ沐铘蝻殇惚┅ㄤ彐躅轭翦蜚祯篝弪狯弪徵瀛麸沐铘蝻殇蟓扉铍徵ㄣ惚戾è惆痫轭趔ㄣ痫轭趔惆┅ㄣ杯痫轭趔ㄣ痫轭趔惚┅戾è惆戾铉翳惆痫轭趔┅ㄣ杯戾铉翳惚痫轭趔┅ǒㄦ戾è篚憝麸ㄣ孱趄镩痫轭趔祜镳骘轭痫轭趔篚眄轭ㄤ瓠痫沐铘蝻殇┅┅ǐ篚憝麸ㄣ沐铘蝻殇惆惚痫轭趔篚憝麸ㄣ沐铘蝻殇惚惆痫轭趔┅ǐ惆惚瞟┅┅ㄤ彐躅轭翦蜚祯篝弪栳躞滹蜴姝扉铍徵ㄣ惚戾è惆痫轭趔ㄣ痫轭趔惆┅ㄣ杯痫轭趔ㄣ痫轭趔惚┅ㄦ戾è磲黹瞽痼痼ㄩ翦ㄦ矧轭箦聃孱沐痼磲轫辁轭ㄩ翦ㄦ矧轭箦聃孱沐痼黹铋黹轭瓠┅┅┅磲磲黹瞽惆痫轭趔惚痫轭趔磲黹瞽惚痫轭趔惆痫轭趔┅┅ㄤ彐躅轭翦蜚祯篝弪ㄣ惚脲礤翳镤恒孱趄镩洎ㄥ汜箦礤翳镤ê沐铘蝻殇ㄩ铘弪沆躞翦颦沐铘蝻殇扉铍徵惆惚┅ê箝铉戾ㄩ铘弪沆躞翦颦箝铉戾扉铍徵惆惚┅ê泔眇戾翦ㄩ铘弪沆躞翦颦泔眇戾翦扉铍徵惆惚┅ê狯弪徵ㄩ铘弪沆躞翦颦狯弪徵瀛扉铍徵惆惚┅ê狯弪徵瀛麸沐铘蝻殇ㄩ铘弪沆躞翦颦狯弪徵瀛麸沐铘蝻殇蟓扉铍徵惆惚┅ê栳躞滹蜴ㄩ铘弪沆躞翦颦栳躞滹蜴姝扉铍徵惆惚┅┅ㄤ彐躅轭趄徙祯篝弪溟犴弭弪ㄣ脲礤翳镤恒孱趄镩洎ㄥ汜箦礤翳镤ê沐铘蝻殇ㄩ铘蜥沆躞翦颦沐铘蝻殇溟犴弭弪悌ê泔眇戾翦ㄩ铘蜥沆躞翦颦泔眇戾翦溟犴弭弪悌ê狯弪徵ㄩ铘蜥沆躞翦颦狯弪徵瀛溟犴弭弪悌┅ㄤ彐躅篌īㄩ翦ㄦ矧轭箦聃孱沐瘅沆躞翦蝮黠螂箴徙濯┅戾è眭ㄣ沐铘弪悌┅篚眄轭祜镳骘轭ㄣ痫轭趔悌篚眄轭霏溟骀篚磙瓠痫皓眭┅┅┅ㄤ彐躅篌ī戾è眭ㄣ孱趄镩洎┅ㄩ翦ㄦ矧轭箦聃孱沐瘅沆躞翦蝮黠螂箴徙濯┅篚眄轭íㄣ箝悌霏溟骀篚磙ㄣ沐铘弪悌眭┅┅┅ㄤ彐躅篌ī戾è眭ㄣ孱趄镩洎┅ㄩ翦ㄦ矧轭箦聃孱沐瘅痫轭趔黠螂箴徙濯┅篚眄轭霏溟骀篚磙瓠痫皓眭┅┅ㄤ彐躅磲脲弪锃漩邈ī戾èㄣ镳箦瓠痫ㄥ祠瘅痫轭趔黠螂箴徙濯癌┅┅ㄦ殪飙鲥颁癌雯ㄤ彐躅沐铘蝻殇ī戾è磲脲弪锃漩邈┅癌瘅痫轭趔瘅痫轭趔黠螂箴徙濯┅ㄤ锃鲥瘅痫轭趔呼疱痫轭舂霁瓠痫皓悌ㄩ钽瞟霏筱犰翳滹踱戾骒镝ǒ变ㄣ镥蜚т秕忪瀛骒镝舂┅悌悌ㄤ彐躅汜扉铙腴é镳糸镱犰í黠螂箴徙濯黠螂箴徙濯┅戾è戾铉翳瘅痫轭趔黠螂箴徙濯┅戾铉翳瘅沆躞翦蝮黠螂箴徙濯┅┅ǒí篌猢ōū瞟氅í篌鳗ū氅┅┅ㄤ彐躅栳螋殓犷é镳糸镱犰í黠螂箴徙濯黠螂箴徙濯┅ō祜篌猢祜篌鳗┅ㄤ彐躅忉祆犷洵栳祆é镳糸镱犰í黠螂箴徙濯黠螂箴徙濯┅戾è戾铉翳瘅沆躞翦蝮黠螂箴徙濯┅┅ǒ篌鳗氅┅ㄤ彐躅漉铑轭溴é脲í黠螂箴徙濯黠螂箴徙濯ㄤ轶翎钽哄蹉扉洎ㄩ铘弪沆躞翦恒孱趄镩洎ㄩ铘蜥沆躞翦恒孱趄镩洎箦舡溟篝犷沐溟篝犷沐戾è沆躞翦蝮瘅沆躞翦蝮黠螂箴徙濯┅ǒㄩ翦ㄦ矧惆轭箦聃孱沐沆躞翦蝮黹铋黹轭ㄩ翦ㄦ矧惚轭箦聃孱沐沆躞翦蝮躅戾篌ㄥ惆惚黹铋黹轭ㄩ铘弪沆躞翦颦惆惚喉弭栾轭翦蜚祯篝弪┅┅┅ㄩ翦ㄦ矧轭箦聃孱沐沆躞翦蝮磲轫辁轭ㄩ铘蜥沆躞翦颦溟犴弭弪喉弭栾轭趄徙祯篝弪┅┅┅ㄤ彐躅溽鲩弩怙蹯溟瞽轭溴é脲í黠螂箴徙濯黠螂箴徙濯ㄤ轶翎钽哄蹉扉洎ㄩ铘弪沆躞翦恒孱趄镩洎ㄩ铘蜥沆躞翦恒孱趄镩洎箦舡溟篝犷沐溟篝犷沐戾舄è沆躞翦蝮瘅沆躞翦蝮黠螂箴徙濯┅ㄣ殇磲ъ轶＇灬礅溽ㄣㄩ铘蜥沆躞翦颦溟犴弭弪喉弭栾轭趄徙祯篝弪┅沆躞翦蝮┅ㄣ戾铉翳沆躞翦蝮┅ǒㄩ翦ㄦ矧惆轭箦聃孱沐沆躞翦蝮ㄦ矧惆殇轭箦聃孱沐汩潴篚眄轭ㄩ翦ㄦ矧惚轭箦聃孱沐沆躞翦蝮ㄦ矧惚殇轭箦聃孱沐汩潴躅戾篌ㄥ惆惚磲轫辁轭ǒǐ惚殇惆殇ㄩ铘弪沆躞翦颦惆惚喉弭栾轭翦蜚祯篝弪┅┅┅悌┅ㄤ彐躅珈镡犰箝扈秕弭翦鲠祯é脲í黠螂箴徙濯黠螂箴徙濯ㄤ轶翎钽哄蹉扉洎箦舡溟篝犷沐溟篝犷沐ㄩ翦ㄦ矧轭箦聃孱沐瘅沆躞翦蝮黠螂箴徙濯┅篚眄轭箝扈秕弭翦悌轭麸螬ㄣ秕铘轭轭麸瞟ㄦ轭犰禊蝈趱蝾ǒ瞟┅┅